##############################################################
##
## Name         :   muse_setup
## Author       :   Bradley Atkins
## Description  :   Create the users and sudo permissions
##                  required to install and run MUSE
## Date         :   28/10/2015
## Status       :   Reviewed    [n]
##                  Tested      [n]
##                  Released    [n]
##############################################################

die()
{
    echo "ERROR: ${1}"
    exit 1
}
#======================================
# Add sudo rights for sysadmin group
#======================================
if ! grep "%sysadmin ALL=(ALL) NOPASSWD:ALL" /etc/sudoers >/dev/null 2>&1
then
    cp /etc/sudoers /etc/sudoers.bac || die "Failed to back up /etc/sudoers"

    if ! grep "%sysadmin ALL=(ALL) ALL" /etc/sudoers >/dev/null 2>&1
    then
        echo "%sysadmin ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers || 
            die "Failed to add sysadmin to sudoers"
    else
        sed -i 's/sysadmin ALL=(ALL) ALL/sysadmin ALL=(ALL) NOPASSWD:ALL/' /etc/sudoers ||
            die "Failed to modify /etc/sudoers for sysadmin group"
    fi
fi
#======================================
# Do we have a sysadmin group?
#======================================
if ! cat /etc/group | grep sysadmin >/dev/null 2>&1
then
    groupadd sysadmin
fi


#======================================
# User musedeploy
#======================================
USR="musedeploy"
KEY="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSKqwvhbzYGbQo6d4imM25UE1y3nCh/OrO0Iq2NGQKYIYlGNsj++Nzr9h4wPDhfQePk7gIVs4t10WNON9hxWQH0lSUsMrjyorF8JdJdemiLnmO/wGePeKQleJc4uaBSVrLJzSbxhQl6MVRwmmHL0gXqX/CnOe1KCauveZ5tGE+kaFirsZoa56I95/AiYrjab0BASM2AoPHVcz4kbflE4VVLpgPQ5nkgLZi101lGcW0KfxHOr/h5siZY7CJKqAo0aCbDK8MtW/SNE1jt7QMrYGYqWrAqG67y/g3ZGTgH3YEt18Q0/s23ZnLPdfMNqoPG9231lCcyRnvkadagEIwaZNT batkins@al-car-06179.local"

#======================================
# re/create user 
#======================================
if id ${USR} >/dev/null 2>&1
then
    userdel -r ${USR} || die "Failed to delete user (${USR})"
fi
useradd -c "MUSE deployment user" -m -G sysadmin ${USR} || die 1 "Failed to create user ${USR}"

MDHOME=$(eval echo ~${USR})
[[ -d ${MDHOME} ]] || die "useradd failed to create home dir for ${USR}"
[[ -d ${MDHOME}/.ssh ]] || mkdir ${MDHOME}/.ssh || 
    die "Useradd cmd failed to create ssh dir for ${USR}" 
#======================================
# Do we need to add key for user
#======================================
if ! grep "${KEY}" ${MDHOME}/.ssh/authorized_keys >/dev/null 2>&1
then
    ## Add user to authorized_keys
    echo "${KEY}" >> ${MDHOME}/.ssh/authorized_keys || 
        die "Failed to set authorized key for ${USR}"
fi
#======================================
# Set permissions for authorized_keys
#======================================
chmod 600 ${MDHOME}/.ssh/authorized_keys || 
    die "Failed to set permissions for authorized keys for ${USR}"
chown ${USR}:${USR} ${MDHOME}/.ssh/authorized_keys || 
    die "Failed to set ownership of ${MDHOME}/.ssh/authorized_keys"


#======================================
# User museslave
#======================================
USR="museslave"
KEY='command="nohup /usr/local/bin/muse_root/slave/system/slave ${SSH_ORIGINAL_COMMAND} /dev/null 2>&1 </dev/null &",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDCw4JjUPvqGHCplYWODuDzdk/IjQS2MReK+zxKjlqEXrRrUhj42A0MIA0mzjUmWfZIdT84+9Z6xklmQeTJc96rXAiyfP4xEjwVQmGI5y6LVoluHDqkuwwe1bBF/45WLfzTRHqx6qK28rRNz8ymfbdltuh05DRBLNtJtpAz498bYVkMWUZCHgxzUocNA312R7aZHTHAZQ7Hj001IJfpaSt1QZXv1fv8zGCjVDEWWRIhlP2JVFQv1VLxuv6QUsnhRkHPG9Mx+p9UWCRjbKDWdBlE162I4jkgIZJOtgeMJMCPRfkbASnt6fIKsUo/Qh66YYjHK4tuLYo9rczpuYkUnugl batkins@al-car-06179.local'

#======================================
# re/create user 
#======================================
if id ${USR} >/dev/null 2>&1
then
    userdel -r ${USR} || die "Failed to delete user (${USR})"
fi
useradd -c "MUSE slave user" -m -G sysadmin ${USR} || die 1 "Failed to create user ${USR}"

MDHOME=$(eval echo ~${USR})
[[ -d ${MDHOME} ]] || die "useradd failed to create home dir for ${USR}"
[[ -d ${MDHOME}/.ssh ]] || mkdir ${MDHOME}/.ssh || 
    die "Useradd cmd failed to create ssh dir for ${USR}" 
#======================================
# Do we need to add key for user
#======================================
if ! grep "${KEY}" ${MDHOME}/.ssh/authorized_keys >/dev/null 2>&1
then
    ## Add user to authorized_keys
    echo "${KEY}" >> ${MDHOME}/.ssh/authorized_keys || 
        die "Failed to set authorized key for ${USR}"
fi
#======================================
# Set permissions for authorized_keys
#======================================
chmod 600 ${MDHOME}/.ssh/authorized_keys || 
    die "Failed to set permissions for authorized keys for ${USR}"
chown ${USR}:${USR} ${MDHOME}/.ssh/authorized_keys || 
    die "Failed to set ownership of ${MDHOME}/.ssh/authorized_keys"


#======================================
# User musemsg
#======================================
USR="musemsg"
KEY='command="cat >> ${SSH_ORIGINAL_COMMAND}",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC7S5+j2awxdLXpelzxj2FftZvEijfaMrXJoN1eE21R0zDQp13Hn1BXoQFn6qtWs7vhztnaS7rd5FFiGQw5WSTeRs4+bIbSHZv1ddMjVOGb+2Cimg/Y0q8oV/NPJVdE1CezRePOEcs6entfQeDxcAybb/nb7yjcN1rqzg/KSUzG5bokIQ1zJ5vj+8ZtyMXiozBgyhdCIeOUEEdagVqvEIelXxCrHz/6Z4MwSN5jhSu6ghAjX9nssnr4cUXTTr+TjbRuPOYqAAx3IXWtQYnI+1Zjp7SeYkiguq+2n9m3EmuqU97y9GorioMWvBAB3PRhr3dM+wlj39g1rArG76PEQmc1 batkins@al-car-06179.local'

#======================================
# re/create user 
#======================================
if id ${USR} >/dev/null 2>&1
then
    userdel -r ${USR} || die "Failed to delete user (${USR})"
fi
useradd -c "MUSE slave user" -m ${USR} || die 1 "Failed to create user ${USR}"

MDHOME=$(eval echo ~${USR})
[[ -d ${MDHOME} ]] || die "useradd failed to create home dir for ${USR}"
[[ -d ${MDHOME}/.ssh ]] || mkdir ${MDHOME}/.ssh || 
    die "Useradd cmd failed to create ssh dir for ${USR}" 
#======================================
# Do we need to add key for user
#======================================
if ! grep "${KEY}" ${MDHOME}/.ssh/authorized_keys >/dev/null 2>&1
then
    ## Add user to authorized_keys
    echo "${KEY}" >> ${MDHOME}/.ssh/authorized_keys || 
        die "Failed to set authorized key for ${USR}"
fi
#======================================
# Set permissions for authorized_keys
#======================================
chmod 600 ${MDHOME}/.ssh/authorized_keys || 
    die "Failed to set permissions for authorized keys for ${USR}"
chown ${USR}:${USR} ${MDHOME}/.ssh/authorized_keys || 
    die "Failed to set ownership of ${MDHOME}/.ssh/authorized_keys"

